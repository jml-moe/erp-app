{% extends 'dashboard_base.html' %}

{% block page_name %}
Add Line - {{ invoice.reference }}
{% endblock %}

{% block dashboard_content %}
<div class="max-w-2xl">
    <form method="post" class="bg-white rounded-lg border border-neutral-200 p-6">
        {% csrf_token %}
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="col-span-2">
                <label class="block text-sm font-medium text-neutral-700 mb-1">Product *</label>
                {{ form.product }}
            </div>
            
            <div class="col-span-2">
                <label class="block text-sm font-medium text-neutral-700 mb-1">Description</label>
                {{ form.description }}
            </div>
            
            <div>
                <label class="block text-sm font-medium text-neutral-700 mb-1">Quantity *</label>
                {{ form.quantity }}
            </div>
            
            <div>
                <label class="block text-sm font-medium text-neutral-700 mb-1">Unit Price *</label>
                {{ form.unit_price }}
            </div>
            
            <div>
                <label class="block text-sm font-medium text-neutral-700 mb-1">Discount (%)</label>
                {{ form.discount_percent }}
            </div>
        </div>
        
        <div class="flex justify-end gap-2">
            <a href="{% url 'invoice-detail' invoice.pk %}" class="bg-neutral-200 text-neutral-700 py-2 px-6 rounded-lg hover:bg-neutral-300 font-medium">
                Cancel
            </a>
            <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 font-medium">
                Add Line
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productSelect = document.querySelector('select[name="product"]');
    const unitPriceInput = document.querySelector('input[name="unit_price"]');
    const descriptionInput = document.querySelector('input[name="description"]');
    
    if (productSelect && unitPriceInput) {
        productSelect.addEventListener('change', function() {
            const productId = this.value;
            if (productId) {
                // Fetch product price (sales price)
                fetch(`/products/api/products/${productId}/price/?type=sales`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            unitPriceInput.value = data.price;
                            if (descriptionInput && !descriptionInput.value) {
                                descriptionInput.value = data.product_name;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching product price:', error);
                    });
            } else {
                unitPriceInput.value = '';
            }
        });
    }
});
</script>
{% endblock %}

